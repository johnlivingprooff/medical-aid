import{j as e}from"./ui-vendor-BwlLg9O9.js";import{r as t}from"./react-vendor-BV8CqAlW.js";import{C as H,a as K,b as V,d as q}from"./card-B87lmAsb.js";import{I as o}from"./input-CqLO7V2k.js";import{L as r}from"./label-_J7CDay_.js";import{a as l,B as m}from"./index-DvB6HgzU.js";import{X}from"./utils-vendor-BEyFXcp4.js";function se({open:p,onOpenChange:f,schemeId:x}){const[_,g]=t.useState(""),[A,v]=t.useState(""),[T,L]=t.useState(!1),[Y,u]=t.useState(null),[i,j]=t.useState(null),[M,y]=t.useState([]),[k,N]=t.useState([]),[c,d]=t.useState(""),[n,h]=t.useState(""),[b,w]=t.useState(""),[S,C]=t.useState(""),[F,B]=t.useState("YEARLY"),[P,R]=t.useState(!1),[D,E]=t.useState(null);t.useEffect(()=>{p&&(g(""),v(""),j(null),y([]),d(""),h(""),w(""),C(""),B("YEARLY"),u(null),E(null),l.get("/api/schemes/benefit-types/").then(s=>N(s.results??s)).catch(()=>N([])),x&&l.get(`/api/schemes/categories/${x}/`).then(s=>{j(s),g(s.name??""),v(s.description??""),y(s.benefits??[])}).catch(s=>u(s.message||"Failed to load scheme")))},[p,x]);async function $(s){if(s.preventDefault(),!i){L(!0),u(null);try{const a=await l.post("/api/schemes/categories/",{name:_,description:A});j(a)}catch(a){u(a.message||"Failed to add scheme")}finally{L(!1)}}}async function W(){if(c)return c;if(!n.trim())throw new Error("Select a benefit type or enter a new one");const s=await l.post("/api/schemes/benefit-types/",{name:n.trim()});return N([s,...k]),h(""),d(s.id),s.id}async function z(s){if(s.preventDefault(),!!i){R(!0),E(null);try{const a=await W();await l.post("/api/schemes/benefits/",{scheme:i.id,benefit_type:a,coverage_amount:b?Number(b):null,coverage_limit_count:S?Number(S):1,coverage_period:F});const I=await l.get(`/api/schemes/categories/${i.id}/`);y(I.benefits??[]),d(""),w(""),C(""),B("YEARLY")}catch(a){E(a.message||"Failed to add benefit")}finally{R(!1)}}}return p?e.jsx("div",{className:"fixed inset-0 z-50 grid p-4 place-items-center bg-black/40",onClick:()=>f(!1),children:e.jsxs(H,{className:"w-full max-w-3xl",onClick:s=>s.stopPropagation(),children:[e.jsxs(K,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(V,{children:"Manage Schemes"}),e.jsx(m,{variant:"ghost",size:"sm",className:"h-6 w-6 p-0 hover:bg-muted",onClick:()=>f(!1),children:e.jsx(X,{className:"h-4 w-4"})})]}),e.jsxs(q,{className:"max-h-[70vh] overflow-y-auto space-y-6",children:[e.jsxs("form",{onSubmit:$,className:"grid grid-cols-1 gap-4 sm:grid-cols-3",children:[e.jsxs("div",{className:"space-y-2 sm:col-span-1",children:[e.jsx(r,{htmlFor:"name",children:"Scheme Name"}),e.jsx(o,{id:"name",value:_,onChange:s=>g(s.target.value),required:!0,disabled:!!i})]}),e.jsxs("div",{className:"space-y-2 sm:col-span-2",children:[e.jsx(r,{htmlFor:"desc",children:"Description"}),e.jsx(o,{id:"desc",value:A,onChange:s=>v(s.target.value),disabled:!!i})]}),e.jsxs("div",{className:"flex justify-end gap-2 sm:col-span-3",children:[e.jsx(m,{type:"button",variant:"ghost",onClick:()=>f(!1),children:"Close"}),!i&&e.jsx(m,{type:"submit",disabled:T,children:T?"Creating…":"Create Scheme"})]}),Y&&e.jsx("div",{className:"text-sm sm:col-span-3 text-destructive",children:Y})]}),i&&e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"text-sm text-muted-foreground",children:["Adding benefits to ",e.jsx("span",{className:"font-medium text-foreground",children:i.name})]}),e.jsxs("form",{onSubmit:z,className:"grid grid-cols-1 gap-3 sm:grid-cols-5",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx(r,{children:"Benefit"}),e.jsxs("select",{className:"w-full px-3 text-sm border rounded-md h-9 bg-background",value:c===""?n?"new":"":c,onChange:s=>{s.target.value==="new"?d(""):(d(s.target.value?Number(s.target.value):""),h(""))},children:[e.jsx("option",{value:"",children:"Select benefit type…"}),k.map(s=>e.jsx("option",{value:s.id,children:s.name},s.id)),e.jsx("option",{value:"new",children:"+ Add new benefit type…"})]}),c===""&&e.jsxs("div",{className:"flex items-center gap-2 pt-1",children:[e.jsxs("div",{className:"relative",children:[e.jsx(o,{placeholder:"Enter new type name",value:n,onChange:s=>h(s.target.value),style:{width:`${Math.max(12,n.length*.75+2)}ch`,minWidth:"12ch",maxWidth:"100%",transition:"width 0.2s"}}),e.jsx("span",{style:{position:"absolute",visibility:"hidden",whiteSpace:"pre",fontSize:"inherit",fontFamily:"inherit",padding:0,margin:0},"aria-hidden":"true",children:n||"Enter new type name"})]}),e.jsx(m,{type:"button",variant:"secondary",onClick:async()=>{try{await W()}catch{}},disabled:!n.trim(),children:"Add Benefit Type"})]})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx(r,{children:"Amount (MWK)"}),e.jsx(o,{value:b,onChange:s=>w(s.target.value),placeholder:"e.g. 500000"})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx(r,{children:"Limit count"}),e.jsx(o,{value:S,onChange:s=>C(s.target.value),placeholder:"e.g. 12 (default: 1)"})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx(r,{children:"Period"}),e.jsxs("select",{className:"w-full px-3 text-sm border rounded-md h-9 bg-background",value:F,onChange:s=>B(s.target.value),children:[e.jsx("option",{value:"PER_VISIT",children:"Per Visit"}),e.jsx("option",{value:"MONTHLY",children:"Monthly"}),e.jsx("option",{value:"YEARLY",children:"Yearly"})]})]}),e.jsx("div",{className:"flex items-end justify-end gap-2",children:e.jsx(m,{type:"submit",disabled:P,children:P?"Adding…":"Add Benefit"})}),D&&e.jsx("div",{className:"text-sm sm:col-span-5 text-destructive",children:D})]}),M.length>0&&e.jsxs("div",{className:"space-y-2",children:[e.jsx("div",{className:"text-sm font-medium",children:"Benefits added"}),e.jsx("div",{className:"grid grid-cols-1 gap-2",children:M.map(s=>{var a;return e.jsx("div",{className:"flex items-center justify-between p-2 text-sm border rounded",children:e.jsxs("div",{children:[e.jsx("div",{className:"font-medium",children:(a=s.benefit_type_detail)==null?void 0:a.name}),e.jsxs("div",{className:"text-xs text-muted-foreground",children:[s.coverage_period," • ",s.coverage_limit_count??"No count limit"," • ",s.coverage_amount!=null?`${s.coverage_amount} MWK`:"No amount limit"]})]})},s.id)})})]})]})]})]})}):null}export{se as M};
