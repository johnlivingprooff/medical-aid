{% extends "admin/base.html" %}
{% load static %}

{% block title %}{{ title }}{% endblock %}

{% block content %}
<div id="content-main">
    <div class="module">
        <h1>{{ title }}</h1>

        <!-- Health Status -->
        <div class="module">
            <h2>System Health</h2>
            {% if health_status.error %}
                <div class="errornote">
                    <p><strong>Health Check Error:</strong> {{ health_status.error }}</p>
                </div>
            {% else %}
                <table class="table table-striped">
                    <thead>
                        <tr>
                            <th>Component</th>
                            <th>Status</th>
                            <th>Details</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>Database</td>
                            <td>
                                {% if health_status.database %}
                                    <span style="color: green;">✓ Healthy</span>
                                {% else %}
                                    <span style="color: red;">✗ Unhealthy</span>
                                {% endif %}
                            </td>
                            <td>-</td>
                        </tr>
                        <tr>
                            <td>Cache</td>
                            <td>
                                {% if health_status.cache %}
                                    <span style="color: green;">✓ Healthy</span>
                                {% else %}
                                    <span style="color: red;">✗ Unhealthy</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if health_status.cache_error %}
                                    {{ health_status.cache_error }}
                                {% else %}
                                    -
                                {% endif %}
                            </td>
                        </tr>
                    </tbody>
                </table>
            {% endif %}
        </div>

        <!-- Task Statistics -->
        <div class="module">
            <h2>Task Statistics (Last 24 Hours)</h2>
            <div style="display: flex; gap: 20px; margin-bottom: 20px;">
                <div style="background: #f8f9fa; padding: 15px; border-radius: 5px; flex: 1;">
                    <h3 style="margin: 0; color: #666;">Total Tasks</h3>
                    <p style="font-size: 24px; font-weight: bold; margin: 5px 0;">{{ total_tasks }}</p>
                </div>
                <div style="background: #d4edda; padding: 15px; border-radius: 5px; flex: 1;">
                    <h3 style="margin: 0; color: #155724;">Successful</h3>
                    <p style="font-size: 24px; font-weight: bold; margin: 5px 0;">{{ successful_tasks }}</p>
                </div>
                <div style="background: #f8d7da; padding: 15px; border-radius: 5px; flex: 1;">
                    <h3 style="margin: 0; color: #721c24;">Failed</h3>
                    <p style="font-size: 24px; font-weight: bold; margin: 5px 0;">{{ failed_tasks }}</p>
                </div>
                <div style="background: #cce7ff; padding: 15px; border-radius: 5px; flex: 1;">
                    <h3 style="margin: 0; color: #004085;">Success Rate</h3>
                    <p style="font-size: 24px; font-weight: bold; margin: 5px 0;">{{ success_rate|floatformat:1 }}%</p>
                </div>
            </div>
        </div>

        <!-- Active Periodic Tasks -->
        <div class="module">
            <h2>Active Periodic Tasks</h2>
            {% if active_periodic_tasks %}
                <table class="table table-striped">
                    <thead>
                        <tr>
                            <th>Task Name</th>
                            <th>Schedule</th>
                            <th>Last Run</th>
                            <th>Enabled</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for task in active_periodic_tasks %}
                        <tr>
                            <td>{{ task.name }}</td>
                            <td>{{ task.schedule }}</td>
                            <td>{{ task.last_run_at|default:"Never" }}</td>
                            <td>
                                {% if task.enabled %}
                                    <span style="color: green;">✓ Yes</span>
                                {% else %}
                                    <span style="color: red;">✗ No</span>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            {% else %}
                <p>No active periodic tasks found.</p>
            {% endif %}
        </div>

        <!-- Recent Task Results -->
        <div class="module">
            <h2>Recent Task Results</h2>
            {% if recent_tasks %}
                <table class="table table-striped">
                    <thead>
                        <tr>
                            <th>Task Name</th>
                            <th>Status</th>
                            <th>Started</th>
                            <th>Duration</th>
                            <th>Result</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for task in recent_tasks %}
                        <tr>
                            <td>{{ task.task_name }}</td>
                            <td>
                                {% if task.status == 'SUCCESS' %}
                                    <span style="color: green;">✓ {{ task.status }}</span>
                                {% elif task.status == 'FAILURE' %}
                                    <span style="color: red;">✗ {{ task.status }}</span>
                                {% else %}
                                    <span style="color: orange;">{{ task.status }}</span>
                                {% endif %}
                            </td>
                            <td>{{ task.date_created|date:"M d, H:i:s" }}</td>
                            <td>
                                {% if task.date_done %}
                                    {{ task.date_done|timeuntil:task.date_created }}
                                {% else %}
                                    -
                                {% endif %}
                            </td>
                            <td>
                                {% if task.result %}
                                    <details>
                                        <summary>View Result</summary>
                                        <pre style="max-width: 400px; overflow: auto;">{{ task.result }}</pre>
                                    </details>
                                {% else %}
                                    -
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            {% else %}
                <p>No recent tasks found.</p>
            {% endif %}
        </div>

        <!-- Quick Actions -->
        <div class="module">
            <h2>Quick Actions</h2>
            <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                <a href="{% url 'admin:django_celery_beat_periodictask_changelist' %}" class="button">
                    Manage Periodic Tasks
                </a>
                <a href="{% url 'admin:django_celery_results_taskresult_changelist' %}" class="button">
                    View All Task Results
                </a>
                <a href="{% url 'admin:django_celery_beat_crontabschedule_changelist' %}" class="button">
                    Manage Schedules
                </a>
            </div>
        </div>
    </div>
</div>
{% endblock %}